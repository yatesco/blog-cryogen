<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
    <meta charset="utf-8"/>
    <title>Random musings</title>
    <link rel="canonical" href="http://colinyates.co.uk/">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href='http://fonts.googleapis.com/css?family=Alegreya:400italic,700italic,400,700' rel='stylesheet'
          type='text/css'>
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap.min.css">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.1/styles/default.min.css">
    <link href="css/screen.css" rel="stylesheet" type="text/css" />
</head>
<body>


<nav class="navbar navbar-default">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Random musings</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
            <ul class="nav navbar-nav navbar-right">
                <li  class="active" ><a href="/">Home</a></li>
                <li
                ><a href="/archives/">Archives</a></li>
                
                <li
                >
                <a href="/pages-output/about/">About</a>
                </li>
                
                <li><a href="/feed.xml">RSS</a></li>
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
                        More <span class="caret"></span></a>
                    <ul class="dropdown-menu" role="menu">
                        <li class="dropdown-header">Links</li>
                        <li><a href="http://cryogenweb.org/docs/home.html">Cryogen Docs</a></li>
                        <li><a href="http://carmenla.me/blog/archives">Carmen's Blog</a></li>
                        

                        
                        <li class="divider"></li>
                        <li class="dropdown-header">Recent Posts</li>
                        
                        <li><a href="/posts-output/2016-12-08-unraid-and-ssh-keys/">SSH Keys and unRAID</a></li>
                        
                        <li><a href="/posts-output/2016-12-02-lein-manage-dependant-project/">Managing dependant projects with lein</a></li>
                        
                        <li><a href="/posts-output/2016-11-18-nas-fun/">NAS fun</a></li>
                        
                        

                        
                        <li class="divider"></li>
                        <li class="dropdown-header">Tags</li>
                        
                        <li><a href="/tags-output/cloud/">cloud</a></li>
                        
                        <li><a href="/tags-output/ux/">ux</a></li>
                        
                        <li><a href="/tags-output/apple/">apple</a></li>
                        
                        <li><a href="/tags-output/clojure/">clojure</a></li>
                        
                        <li><a href="/tags-output/backup/">backup</a></li>
                        
                        <li><a href="/tags-output/tip/">tip</a></li>
                        
                        <li><a href="/tags-output/ci/">ci</a></li>
                        
                        <li><a href="/tags-output/servers/">servers</a></li>
                        
                        <li><a href="/tags-output/broken promises/">broken promises</a></li>
                        
                        <li><a href="/tags-output/projectile/">projectile</a></li>
                        
                        <li><a href="/tags-output/cljs/">cljs</a></li>
                        
                        <li><a href="/tags-output/storage/">storage</a></li>
                        
                        <li><a href="/tags-output/schema/">schema</a></li>
                        
                        <li><a href="/tags-output/java/">java</a></li>
                        
                        <li><a href="/tags-output/lost/">lost</a></li>
                        
                        <li><a href="/tags-output/lein/">lein</a></li>
                        
                        <li><a href="/tags-output/helm/">helm</a></li>
                        
                        <li><a href="/tags-output/moan/">moan</a></li>
                        
                        <li><a href="/tags-output/unraid/">unraid</a></li>
                        
                        <li><a href="/tags-output/seafile/">seafile</a></li>
                        
                        <li><a href="/tags-output/drivepool/">drivepool</a></li>
                        
                        <li><a href="/tags-output/tv/">tv</a></li>
                        
                        <li><a href="/tags-output/dev/">dev</a></li>
                        
                        <li><a href="/tags-output/emacs/">emacs</a></li>
                        
                        <li><a href="/tags-output/plumatic/">plumatic</a></li>
                        
                        <li><a href="/tags-output/discipline/">discipline</a></li>
                        
                        <li><a href="/tags-output/maven/">maven</a></li>
                        
                        <li><a href="/tags-output/spacemacs/">spacemacs</a></li>
                        
                        <li><a href="/tags-output/ag/">ag</a></li>
                        
                        <li><a href="/tags-output/phantomjs/">phantomjs</a></li>
                        
                        <li><a href="/tags-output/nas/">nas</a></li>
                        
                        <li><a href="/tags-output/circleci/">circleci</a></li>
                        
                        <li><a href="/tags-output/cljsbuild/">cljsbuild</a></li>
                        
                        <li><a href="/tags-output/prismatic/">prismatic</a></li>
                        
                        <li><a href="/tags-output/pydio/">pydio</a></li>
                        
                        <li><a href="/tags-output/online.net/">online.net</a></li>
                        
                        <li><a href="/tags-output/blogging/">blogging</a></li>
                        
                        <li><a href="/tags-output/ssh/">ssh</a></li>
                        
                        <li><a href="/tags-output/infrastructure/">infrastructure</a></li>
                        
                        <li><a href="/tags-output/abstraction/">abstraction</a></li>
                        
                        <li><a href="/tags-output/redemption/">redemption</a></li>
                        
                        <li><a href="/tags-output/clojurescript/">clojurescript</a></li>
                        
                        
                    </ul>
                </li>
            </ul>
        </div><!--/.nav-collapse -->
    </div><!--/.container-fluid -->
</nav>


<div class="container">


    <div class="row">
        <div class="col-lg-12">
            <div id="content">
                
<div id="post">
    <div class="post-header">
    <div id="post-meta" class="row">
        <div class="col-lg-6">08 December 2016</div>
        
    </div>
    <h2>SSH Keys and unRAID</h2>
</div>
<div>
    
    <p>I wanted to <code>rsync</code> some data directly to and from my <a href='https://lime-technology.com'>unRAID</a> server. (And yes, the eagle eyed amongst you will remember I moved away from it <a href='https://colinyates.co.uk/posts-output/2016-11-18-nas-fun/'>previously</a>. I'm back, but that's for another post.)</p><p>The problem is that <code>sshd</code> is a pig about permissions and whilst <code>unRAID</code> does come with some persistent SSH keys, because of the underlying file system (exFAT or FAT32) the permissions are too strict.</p><p>So, what to do?</p><p>Well, as I am sure you know, SSH is all about two files, a private one you own and protect and a public one which you can give out willy-nilly. <i>Usually</i> those are <code>.ssh/id&#95;rsa</code> and <code>.ssh/id&#95;rsa.pub</code> but they can actually come from anywhere. </p><p>The plan is therefore straightforward:</p><ol><li>Find a sensible file system</li><li>Generate a new SSH key pair onto that file system</li><li>Copy the <code>.pub</code> to the client machine</li><li><code>ssh</code> using that key</li></ol><p>Specifically I am  <code>rsync</code>ing, but let's create the keys first.</p><h1><a name="generate&#95;the&#95;keys&#95;and&#95;secure&#95;them"></a>Generate the keys and secure them</h1><p>Given <code>unRAID</code> is all about your shares, and those shares live on an XFS filesystem, why not choose a (very secure and not public!) share? I therefore created one share called "vault", locked it down in <code>unRAID</code> and created the relevant keys: <pre><code>mkdir /mnt/user/Vault
ssh-keygen -t RSA -f /mnt/user/Value/clientA
 </code></pre> (<i>make sure you don't use a passkey for the SSH keys themselves</i>)</p><p>This creates <code>/mnt/user/Vault/clientA</code> and <code>/mnt/user/Value/clientA.pub</code>. The <code>.pub</code> is the public key you can throw around with abandon. The one without the <code>.pub</code> is your private one which you want to wrap in tinfoil and put in a locked box.</p><p>The permissions for both should be no more than 0600 (user read and write only), but <code>ssh-keygen</code> does that automatically. If not then a <code>chmod 0600 &lt;clientA&gt;&#42;</code> will suffice.</p><h1><a name="copy&#95;the&#95;<code>.pub</code>&#95;to&#95;the&#95;client&#95;machine"></a>Copy the <code>.pub</code> to the client machine</h1><p>Simple as <code>ssh-copy-id -l &lt;the remote user&gt; -i /mnt/user/Vault/clientA.pub &lt;the remote server&gt;</code> . Note you are copying the <code>.pub</code>lic key, not the private one! Enter the password and that if it all goes well that is the last time you need to enter that password ;-).</p><h1><a name="ssh&#95;using&#95;that&#95;key"></a>SSH using that key</h1><p>A subsequent <code>ssh -l &lt;the remote user&gt; -i /mnt/user/Vault/clientA.pub &lt;the remote server&gt;</code> should get you in immediately. </p><p>Great, but what has this got to do with <code>rsync</code>? Well, <code>rsync</code> and <i>many</i> other things work over <code>ssh</code>. All we need to do is tell <code>rsync</code> which key to use:<pre><code>rsync -avz --stats --progress --rsh=&quot;ssh -l &lt;the remote user&gt; -i /mnt/user/Vault/clientA&quot; &lt;the remote IP&gt;:&lt;the path you want to retrieve&gt; &lt;the local dir the remote dir will sync to&gt; 
 </code></pre> <i>(note, you want to reference your private key here</i>)</p><p>So, if my remote username is "bobby", the server is called "bobserver", the remote directory is "/opt/photos" and it is going be stored into <code>/mnt/user/BobsBackup</code> I would do the following:<pre><code>ssh-keygen -t rsa -f /mnt/user/Vault/bobby
ssh-copy-id -i /mnt/user/Vault/bobby.pub bobby@bobserver
rsync -avz --stats --progress -rsh=&quot;ssh -l bobby -i /mnt/user/Vault/bobby&quot; bobserver:/opt/photos /mnt/user/BobsBackup
 </code></pre></p><p>The next job is to add a <code>cron</code> job to do the <code>rsync</code> at a regular schedule. That is a post for another day (trivially editing <code>/boot/config/go</code> really, but my tea is ready :-))</p><h1><a name="a&#95;variation"></a>A variation</h1><p>If you didn't want to create your keys on a share then the alternative would be to edit <code>/boot/config/go</code> to copy the keys (maybe even the already existing <code>/boot/config/ssh/&#42;.keys</code>) onto a sensible file system, <code>chmod 0600</code> them and then reference those.</p><p>Great - go for it :-).</p>
</div>

<div id="post-tags">
    <b>Tags: </b>
    
    <a href="/tags-output/unraid/">unraid</a>
    
    <a href="/tags-output/ssh/">ssh</a>
    
</div>


    
    <div id="comments">
        <a href="/posts-output/2016-12-08-unraid-and-ssh-keys/#disqus_thread">View Comments</a>
    </div>
    

    <div id="prev-next">
        
        
        <a class="right" href="/posts-output/2016-12-02-lein-manage-dependant-project/">Managing dependant projects with lein &raquo;</a>
        
    </div>
</div>

            </div>
        </div>
    </div>
    <footer>Copyright &copy; 2016 Colin Yates
        <p style="text-align: center;">Powered by <a href="http://cryogenweb.org">Cryogen</a></p></footer>
</div>
<script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
<script src="js/highlight.pack.js" type="text/javascript"></script>
<script>hljs.initHighlightingOnLoad();</script>
</body>
</html>

